<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Cafés List</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			background-color: #fff;
			margin: 0;
			padding: 20px;
		}
		.container {
			max-width: 1200px;
			margin: 0 auto;
			display: flex;
			gap: 20px;
		}
		.search-bar {
			display: flex;
			justify-content: center;
			margin-bottom: 30px;
			position: sticky;
			top: 0;
			background-color: #fff;
			z-index: 10;
			padding: 10px 0;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		.search-bar input {
			padding: 15px;
			width: 60%;
			max-width: 600px;
			border: 1px solid #ddd;
			border-radius: 4px 0 0 4px;
			font-size: 18px;
		}
		.search-bar button {
			padding: 15px 30px;
			background-color: #00af87;
			color: white;
			border: none;
			border-radius: 0 4px 4px 0;
			cursor: pointer;
			font-weight: bold;
			font-size: 18px;
		}
		.search-bar button:hover {
			background-color: #009f78;
		}
		.sidebar {
			width: 250px;
			flex-shrink: 0;
			position: sticky;
			top: 100px;
			height: fit-content;
			display: none;
			padding: 20px;
			background-color: #f9f9f9;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			opacity: 0;
			transition: opacity 0.3s ease; /* Fade-in animation */
		}
		.sidebar.visible {
			display: block;
			opacity: 1;
		}
		.sidebar label {
			display: block;
			margin-bottom: 5px;
			font-weight: bold;
			color: #333;
		}
		.sidebar select {
			width: 100%;
			padding: 12px;
			margin-bottom: 15px;
			border: 1px solid #ddd;
			border-radius: 4px;
		}
		.sidebar button {
			width: 100%;
			padding: 12px;
			background-color: #00af87;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
		.sidebar button:hover {
			background-color: #009f78;
		}
		.chips {
			display: flex;
			flex-wrap: wrap;
			gap: 5px;
			margin-bottom: 10px;
		}
		.chip {
			background-color: #e0e0e0;
			padding: 5px 10px;
			border-radius: 20px;
			display: flex;
			align-items: center;
			gap: 5px;
			font-size: 0.9em;
		}
		.chip button {
			background: none;
			border: none;
			cursor: pointer;
			color: #888;
			padding: 0;
			width: auto;
			font-weight: bold;
		}
		.main-content {
			flex: 1;
		}
		.results-count {
			margin-bottom: 20px;
			font-size: 1.2em;
			color: #333;
		}
		.cafe-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 25px;
		}
		.cafe-card {
			background-color: #fff;
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
			padding: 0;
			overflow: hidden;
			transition: transform 0.2s;
		}
		.cafe-card:hover {
			transform: scale(1.05);
		}
		.cafe-card img {
			width: 100%;
			height: 220px;
			object-fit: cover;
		}
		.cafe-card-content {
			padding: 15px;
		}
		.cafe-card h2 {
			margin: 0 0 10px;
			font-size: 1.6em;
			color: #333;
		}
		.cafe-card p {
			margin: 5px 0;
			color: #666;
			font-size: 0.9em;
		}
		.cafe-card .rating {
			color: #00af87;
			font-size: 1.2em;
		}
		.cafe-card .categories {
			font-style: italic;
			color: #888;
		}
		#loading {
			text-align: center;
			margin: 20px;
			display: none;
			color: #00af87;
		}
		select[multiple] {
			height: 120px;
		}
		.error {
			color: red;
			text-align: center;
		}
		.empty {
			text-align: center;
			color: #555;
		}
	</style>
</head>
<body>
<div class="search-bar">
	<input id="city-filter" placeholder="Search by city (e.g., Kyiv)">
	<button id="search-btn">Search Cafes</button>
</div>
<div class="container">
	<div class="sidebar" id="sidebar">
		<label for="best-for-filter">Best For (Primary Category)</label>
		<select id="best-for-filter">
			<option value="" selected>All Categories</option>
		</select>
		<label for="also-good-for-filter">Also Good For (select multiple)</label>
		<select id="also-good-for-filter" multiple>
			<option value="" disabled>Select Also Good For</option>
		</select>
		<div id="selected-chips" class="chips"></div>
		<button id="reset-filters">Reset Filters</button>
	</div>
	<div class="main-content">
		<h1>Cafés List</h1>
		<div id="results-count" class="results-count"></div>
		<div id="loading">Loading...</div>
		<div class="cafe-grid" id="cafe-grid"></div>
	</div>
</div>
<script>
	// 1. Определение констант URL
	const apiUrl = 'http://127.0.0.1:8000/cafes';
	const categoriesUrl = 'http://127.0.0.1:8000/categories';
	
	// 2. Определение Интерфейсов/Типов для Данных
	/** @typedef {{id: number, title: string, city: string, description: string, image_url: string|null, best_for: string|null, also_good_for: string[]}} CafeData */
	/** @typedef {{name: string}} Category */
		
		// 3. Фронтенд-Модели
	class Cafe {
		constructor(data) {
			this.id = data.id;
			this.title = data.title;
			this.city = data.city;
			this.description = data.description;
			this.image_url = data.image_url;
			this.best_for = data.best_for || 'N/A';
			this.also_good_for = data.also_good_for || [];
		}
		
		getNormalizedCity() {
			return normalizeString(this.city);
		}
		
		getNormalizedBestFor() {
			return normalizeString(this.best_for);
		}
		
		getNormalizedAlsoGoodFor() {
			return this.also_good_for.map(normalizeString);
		}
		
		getFormattedAlsoGoodFor() {
			return this.also_good_for.join(', ') || 'None';
		}
	}
	
	// 4. UI Renderer
	class CafeRenderer {
		constructor(grid) {
			this.grid = grid;
		}
		
		createCafeCard(cafe) {
			const card = document.createElement('div');
			card.className = 'cafe-card';
			
			const img = document.createElement('img');
			img.src = cafe.image_url || 'https://via.placeholder.com/300x220?text=No+Image';
			img.alt = cafe.title;
			card.appendChild(img);
			
			const content = document.createElement('div');
			content.className = 'cafe-card-content';
			
			const title = document.createElement('h2');
			title.textContent = cafe.title;
			content.appendChild(title);
			
			const rating = document.createElement('p');
			rating.className = 'rating';
			rating.innerHTML = '★★★★☆ (4.5)'; // Плейсхолдер
			content.appendChild(rating);
			
			const city = document.createElement('p');
			city.innerHTML = `<strong>City:</strong> ${cafe.city}`;
			content.appendChild(city);
			
			const description = document.createElement('p');
			description.textContent = cafe.description;
			content.appendChild(description);
			
			const bestFor = document.createElement('p');
			bestFor.className = 'categories';
			bestFor.innerHTML = `<strong>Best for:</strong> ${cafe.best_for}`;
			content.appendChild(bestFor);
			
			const alsoGoodFor = document.createElement('p');
			alsoGoodFor.className = 'categories';
			alsoGoodFor.innerHTML = `<strong>Also good for:</strong> ${cafe.getFormattedAlsoGoodFor()}`;
			content.appendChild(alsoGoodFor);
			
			card.appendChild(content);
			return card;
		}
		
		renderCafes(cafes) {
			this.grid.innerHTML = '';
			if (cafes.length === 0) {
				const empty = document.createElement('p');
				empty.className = 'empty';
				empty.textContent = 'No cafes found matching your filters.';
				this.grid.appendChild(empty);
				return;
			}
			cafes.forEach(cafe => this.grid.appendChild(this.createCafeCard(cafe)));
		}
		
		showError(message) {
			this.grid.innerHTML = `<p class="error">Error: ${message}</p>`;
		}
	}
	
	// 5. ApiService
	class ApiService {
		async loadCategories() {
			const response = await fetch(categoriesUrl);
			if (!response.ok) throw new Error('Failed to load categories');
			return await response.json();
		}
		
		async loadCafes() {
			const response = await fetch(apiUrl);
			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.detail || 'Failed to load cafes');
			}
			const data = await response.json();
			return data.map(item => new Cafe(item));
		}
	}
	
	// 6. AppState
	class AppState {
		constructor() {
			this.cafes = [];
			this.categories = [];
			this.eventTarget = new EventTarget();
			this.cityQuery = '';
		}
		
		async init() {
			loading.style.display = 'block';
			try {
				this.categories = await apiService.loadCategories();
				this.populateFilters();
			} catch (error) {
				renderer.showError(`Error loading categories: ${error.message}`);
			}
			
			try {
				this.cafes = await apiService.loadCafes();
				this.updateUI();
			} catch (error) {
				renderer.showError(`Error loading cafes: ${error.message}`);
			} finally {
				loading.style.display = 'none';
			}
		}
		
		populateFilters() {
			bestForFilter.innerHTML = '<option value="" selected>All Categories</option>';
			alsoGoodForFilter.innerHTML = '';
			this.categories.forEach(cat => {
				const option = document.createElement('option');
				option.value = cat.name;
				option.textContent = cat.name;
				bestForFilter.appendChild(option.cloneNode(true));
				alsoGoodForFilter.appendChild(option.cloneNode(true));
			});
		}
		
		getFilteredCafes() {
			const city = normalizeString(this.cityQuery);
			const bestFor = normalizeString(bestForFilter.value);
			const alsoGoodFor = Array.from(alsoGoodForFilter.selectedOptions).map(opt => normalizeString(opt.value));
			return this.cafes.filter(cafe =>
				(!city || cafe.getNormalizedCity().includes(city)) &&
				(!bestFor ||
					cafe.getNormalizedBestFor().includes(bestFor) ||
					cafe.getNormalizedAlsoGoodFor().some(cat => cat.includes(bestFor))
				) &&
				(alsoGoodFor.length === 0 ||
					cafe.getNormalizedAlsoGoodFor().some(cat => alsoGoodFor.includes(cat)))
			);
		}
		
		updateUI() {
			const filtered = this.getFilteredCafes();
			renderer.renderCafes(filtered);
			resultsCount.textContent = `Found ${filtered.length} cafes`;
			this.dispatchChange();
		}
		
		searchByCity() {
			this.cityQuery = cityFilter.value;
			if (this.cityQuery.trim()) {
				sidebar.classList.add('visible');
			} else {
				sidebar.classList.remove('visible');
			}
			this.updateUI();
		}
		
		resetFilters() {
			cityFilter.value = '';
			this.cityQuery = '';
			bestForFilter.value = '';
			Array.from(alsoGoodForFilter.options).forEach(opt => opt.selected = false);
			sidebar.classList.remove('visible');
			this.updateUI();
			updateChips();
		}
		
		onChange(callback) {
			this.eventTarget.addEventListener('stateChange', callback);
		}
		
		dispatchChange() {
			this.eventTarget.dispatchEvent(new Event('stateChange'));
		}
	}
	
	// Утилиты
	function normalizeString(str) {
		return str.trim().toLowerCase().replace(/\s+/g, ' ');
	}
	
	// Функция для обновления чипов
	function updateChips() {
		selectedChips.innerHTML = '';
		Array.from(alsoGoodForFilter.selectedOptions).forEach(opt => {
			const chip = document.createElement('div');
			chip.className = 'chip';
			chip.textContent = opt.value;
			const removeBtn = document.createElement('button');
			removeBtn.textContent = '×';
			removeBtn.onclick = () => {
				opt.selected = false;
				appState.updateUI();
				updateChips();
			};
			chip.appendChild(removeBtn);
			selectedChips.appendChild(chip);
		});
	}
	
	// DOM
	const grid = document.getElementById('cafe-grid');
	const cityFilter = document.getElementById('city-filter');
	const bestForFilter = document.getElementById('best-for-filter');
	const alsoGoodForFilter = document.getElementById('also-good-for-filter');
	const resetFiltersBtn = document.getElementById('reset-filters');
	const searchBtn = document.getElementById('search-btn');
	const loading = document.getElementById('loading');
	const sidebar = document.getElementById('sidebar');
	const selectedChips = document.getElementById('selected-chips');
	const resultsCount = document.getElementById('results-count');
	
	// Инициализация
	const apiService = new ApiService();
	const renderer = new CafeRenderer(grid);
	const appState = new AppState();
	
	appState.init();
	
	// Events
	let timeout;
	function debounceFilter() {
		clearTimeout(timeout);
		timeout = setTimeout(() => appState.updateUI(), 300);
	}
	
	cityFilter.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') {
			appState.searchByCity();
		}
	});
	
	searchBtn.addEventListener('click', () => appState.searchByCity());
	bestForFilter.addEventListener('change', () => appState.updateUI());
	alsoGoodForFilter.addEventListener('change', () => {
		appState.updateUI();
		updateChips();
	});
	resetFiltersBtn.addEventListener('click', () => {
		appState.resetFilters();
	});
</script>
</body>
</html>